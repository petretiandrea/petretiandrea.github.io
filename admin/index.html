<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <link href="/admin/config.yml" type="text/yaml" rel="cms-config-url" />
    <title>Content Manager</title>
  </head>
  <body>
    <script src="https://unpkg.com/decap-cms@^3.1.2/dist/decap-cms.js"></script>
    <script type="module">
      import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";
      window.mermaid = mermaid;

      mermaid.initialize({
        startOnLoad: true,
        theme: "dark",
      });

      console.log("ðŸŽ¨ Mermaid loaded");

      const waitForPreviewIframe = function(callback) {
        const interval = setInterval(() => {
          const iframe = document.getElementById('preview-pane');
          if (iframe && iframe.contentDocument && iframe.contentDocument.body) {
            clearInterval(interval);
            iframe.addEventListener("load", () => {
              callback(iframe);
            });
          }
        }, 50); // controlla ogni 50ms
      }

      // ---------------------------------------------
      // GLOBAL MUTATION OBSERVER FOR PREVIEW BLOCKS
      // ---------------------------------------------
      function initMermaidPreview(root) {
        root.querySelectorAll('.mermaid-preview').forEach(el => renderMermaidBlock(el));
        const observer = new MutationObserver((mutations) => {
          for (const m of mutations) {
            if (m.type === 'childList') {
              m.addedNodes.forEach(node => {
                if (node.nodeType === Node.ELEMENT_NODE) {
                  if (node.classList.contains('mermaid-preview')) {
                    renderMermaidBlock(node);
                  }
                  node.querySelectorAll?.('.mermaid-preview')?.forEach(el => renderMermaidBlock(el));
                }
              });
            }
          }
        });

        observer.observe(root, { childList: true, subtree: true });
      }

      // ---------------------------------------------
      // RENDER FUNCTION
      // ---------------------------------------------
      async function renderMermaidBlock(el) {
        const code = decodeURIComponent(el.getAttribute("data-mermaid-code") || "");
        const id = el.getAttribute("data-mermaid-id");

        if (!code || !window.mermaid) return;

        try {
          const { svg } = await window.mermaid.render(id + "-svg", code);
          el.innerHTML = svg;
          el.style.background = "white";
          el.style.padding = "1rem";
          el.style.borderRadius = "0.5rem";
        } catch (err) {
          el.innerHTML =
            '<div style="color:red;padding:1rem;">Mermaid error: ' +
            err.message +
            "</div>";
        }
      }

      // ---------------------------------------------
      // MERMAID EDITOR COMPONENT
      // ---------------------------------------------
      const mermaidComponent = {
        id: "mermaid",
        label: "Mermaid Diagram",
        fields: [
          {
            name: "code",
            label: "Diagram Code",
            widget: "text"
          }
        ],
        pattern: /^```mermaid\n([\s\S]+?)\n```$/m,
        fromBlock: function (match) {
          const lines = (match[1] || '').split('\n');
          const trimmedLines = lines.map(line => line.trim()).filter(line => line);
          const cleanCode = trimmedLines.join('\n');
          return { code: cleanCode };
        },
        toBlock: function (data) {
          const lines = (data.code || '').split('\n');
          const trimmedLines = lines.map(line => line.trim()).filter(line => line);
          const cleanCode = trimmedLines.join('\n');
          return "```mermaid\n" + cleanCode + "\n```";
        },
        toPreview: function (data) {
          const code = encodeURIComponent(data.code || "");
          const id = "mermaid-" + Math.random().toString(36).substr(2, 9);
  
          return `
            <div class="mermaid-preview"
                data-mermaid-id="${id}"
                data-mermaid-code="${code}"
                style="padding:1rem;border:2px dashed #ccc;border-radius:0.5rem;">
              Rendering diagram...
            </div>`;
        }
      };

      // Register component
      CMS.registerEditorComponent(mermaidComponent);

      // Activate observer
      waitForPreviewIframe((iframe) => {
        const iframeDoc = iframe.contentDocument.body;
        initMermaidPreview(iframeDoc);
      });

    </script>
  </body>
</html>
